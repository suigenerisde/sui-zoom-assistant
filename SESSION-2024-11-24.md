# Zoom Assistant Session - 24.11.2024

## Status
**Transkription funktioniert! Frontend repariert. Server wird neu aufgesetzt.**

Die Live-Transkription funktioniert vollständig - Audio wird vom Zoom Bot empfangen, an Deepgram gesendet, und Transcripts kommen zurück. Das Frontend wurde manuell repariert nachdem Coolify-Deployment fehlschlug.

**Aktuelles Problem:** Backend kann Zoom Bot nicht automatisch starten (kein Docker-Zugriff im Container). Server wird komplett neu aufgesetzt.

## Architektur
```
Frontend (Next.js) → Backend (FastAPI) → Zoom Bot (C++) → Deepgram
     ↓                     ↑                    ↓
zoom-assistant.         Unix Socket ←──────────┘
suimation.de           /tmp/audio/meeting.sock

API: api.zoom-assistant.suimation.de
```

## Gelöste Probleme (diese Session)

| Problem | Lösung | Datei |
|---------|--------|-------|
| **Audio Mono/Stereo** | Zoom SDK = 32kHz MONO, nicht Stereo! `input_channels=1` | `zoom_bot_audio_service.py` |
| **Deepgram 1011 Error** | Audio-Format Konvertierung korrigiert | `zoom_bot_audio_service.py` |
| **Frontend 502 Error** | Manuell Docker Image gebaut + Container erstellt | Server-seitig |
| **Coolify Timeout** | Build dauert >150s, wird gekillt | Workaround: manueller Build |

## Früher Gelöste Probleme

| Problem | Lösung | Datei |
|---------|--------|-------|
| Deepgram SDK v3 Imports | `DeepgramClient`, `LiveOptions`, `LiveTranscriptionEvents` | `transcription_service.py` |
| `utterance_end_ms` Parameter | → `endpointing=300` | `deepgram_service.py` |
| `vad_events` Parameter | Entfernt | `deepgram_service.py` |
| `UtteranceEnd` Event | Entfernt | `deepgram_service.py` |
| SDK v3 async/sync | `await` entfernt bei `start()`, `send()`, `finish()` | `deepgram_service.py` |
| SDK 3.0.0 start() return | Gibt `None` zurück, nicht `True` | `deepgram_service.py` |
| Socket Server/Client Konflikt | Bot=Server, Backend=Client | `zoom_bot_audio_service.py` |
| `--file` required | Optional gemacht | `Config.cpp` |
| `libmeetingsdk.so.1` fehlt | Symlink im Dockerfile | `Dockerfile` |
| Next.js Binding | `ENV HOSTNAME=0.0.0.0` | `frontend/Dockerfile` |

## Git Commits (neueste zuerst)
```
1adea63 Add BotDashboard for live Zoom Bot transcription
51f5022 Fix audio conversion: Zoom SDK outputs mono, not stereo
71cc9cb Add audio format conversion for Deepgram compatibility
1f6c0dc Add audio data flow logging to zoom_bot_audio_service
f7b8ce8 Fix Deepgram start() return value handling for SDK 3.0.0
f9ceacb Fix Deepgram SDK v3 sync methods (remove await from start/send/finish)
8a251b9 Remove deprecated UtteranceEnd event from Deepgram service
ddc7b84 Fix Deepgram SDK v3 parameter in deepgram_service.py
```

## Erfolgreiche Test-Ergebnisse
✅ Bot startet und verbindet zum Meeting
✅ Socket Server läuft und Client verbindet
✅ Audio-Daten werden empfangen (31,300+ Chunks, ~49MB)
✅ **Deepgram Transkription funktioniert!** (183+ Segmente)
✅ Frontend zeigt Live-Transkript
✅ BotDashboard Component funktioniert

## Beispiel-Transkript (erfolgreicher Test)
```
"Der Hector hat seit 10 Jahren gar nichts..."
"Also irgendwas ist sones Meeting, also Meeting beitreten..."
```

## Audio-Format Details
```
Zoom SDK Output:  32kHz, MONO, 16-bit PCM, 640 bytes/chunk
Deepgram Input:   16kHz, MONO, 16-bit PCM (linear16)
Konvertierung:    Downsample 2:1 (jeden 2. Sample nehmen)
```

## Bekanntes Problem: Bot-Start
Das Backend versucht `docker exec` um den Zoom Bot zu starten, aber:
- Backend-Container hat keinen Docker-Zugriff
- Lösung: Bot muss mit `ZOOM_JOIN_URL` Environment Variable gestartet werden

**Workaround:** Bot-Container mit Join-URL als ENV neu starten:
```bash
# In Coolify: ZOOM_JOIN_URL setzen und Container restarten
ZOOM_JOIN_URL=https://us06web.zoom.us/j/MEETING_ID?pwd=PASSWORD
```

## Deployment-Hinweise

### Frontend manuell deployen (falls Coolify timeout)
```bash
# Lokal
cd frontend && tar -czf /tmp/frontend-source.tar.gz --exclude='node_modules' --exclude='.next' .
scp /tmp/frontend-source.tar.gz root@SERVER:/tmp/frontend-build/

# Auf Server
cd /tmp/frontend-build && tar -xzf frontend-source.tar.gz
docker build -t zoom-assistant-frontend:fixed .
docker stop <frontend-container> && docker rm <frontend-container>
docker run -d --name <frontend-container> --network <network> \
  --label 'caddy_0=https://zoom-assistant.suimation.de' \
  --label 'caddy_0.handle_path.0_reverse_proxy={{upstreams 3000}}' \
  --label 'caddy_ingress_network=<network>' \
  zoom-assistant-frontend:fixed
```

### Container-Namen Pattern (Coolify)
```
frontend-rskgk8ckcoogo0k040g0c0kk-XXXXXXXXX
backend-rskgk8ckcoogo0k040g0c0kk-XXXXXXXXX
zoom-bot-rskgk8ckcoogo0k040g0c0kk-XXXXXXXXX
```

## API Endpoints
```bash
# Bot Status
GET https://api.zoom-assistant.suimation.de/api/bot/status

# Bot Join (startet Audio-Service, aber Bot muss separat laufen)
POST https://api.zoom-assistant.suimation.de/api/bot/join
{"join_url": "https://zoom.us/j/...", "display_name": "SUI-Assistant"}

# Transkript abrufen
GET https://api.zoom-assistant.suimation.de/api/bot/transcript

# Bot Leave
POST https://api.zoom-assistant.suimation.de/api/bot/leave
```

## Nächste Schritte
- [ ] Server komplett neu aufsetzen
- [ ] Coolify Build-Timeout erhöhen oder separaten Build-Prozess einrichten
- [ ] Docker-Socket für Backend verfügbar machen (für automatischen Bot-Start)
- [ ] n8n Integration für Transcript-Weiterleitung
